# Event Grid Benchmarking Tools

![Build + Package](https://github.com/hiteshmadan/egbench/actions/workflows/package.yml/badge.svg)


This repository contains the source code for the two tools needed to do end-to-end benchmarking of eventgrid and observe performance metrics.
(1) an eventgrid load generator, and (2) a webhook sink.

Both of them have basic instrumentation to report success/failure rates, request latencies, end to end latencies. Right now reporting can happen either to the console (default) or to Azure AppInsights.

Latency calculation is pretty pedestrian and only manages to report the average latencies (no percentiles/mins/maxes/medians/coordinated omission handling).

These tools are shipped as (cross-platform) docker container images and run anywhere .net core runs.

See the [packages](https://github.com/hiteshmadan?tab=packages&repo_name=egbench) section of this repo to get details on this docker image.


### To generate load:

```
Usage: dotnet egbench.dll publisher start [options]

Options:
  -u|--topic-url                              REQUIRED. URL to which events should be posted to.
  -n|--topic-name                             REQUIRED. String that should be used for stamping eventgrid event envelope's Topic
                                              field or cloud event envelope's source field.
  -s|--topic-schema                           Defaults to EventGrid. Possible values: EventGrid / CloudEvent10 / Custom. Specify the
                                              -d|--data-payload property for Custom topic schema.
  -d|--data-payload                           Specify the data payload when -s|--topic-schema=Custom. Either give inline json or a
                                              file path.
  -p|--publishers                             Number of concurrent publishing "threads", defaults to 1.
  -r|--rps-per-publisher                      Requests per second generated by each publish "thread", defaults to 100.
  -c|--max-concurrent-requests-per-publisher  Max requests kept in flight by each publisher before waiting for older requests to end,
                                              defaults to 1000.
  -e|--events-per-request                     Number of events in each request, defaults to 10.
  -b|--event-size-in-bytes                    Number of bytes per event, defaults to 1024, doesn't take effect if
                                              -s|--topic-schema==Custom. Total request payload size = 2 + (EventsPerRequest *
                                              (EventSizeInBytes + 1) - 1)
  -t|--runtime-in-minutes                     Time after which the publisher auto-shuts down, defaults to 60 minutes. Set to 0 to run
                                              forever.
  -v|--protocol-version                       The protocol version to use, defaults to 1.1.
  --skip-ssl-validation                       Skip SSL Server Certificate validation, defaults to false.
  --log-errors                                Log Status code, reason, and response content of all non-200 responses. Defaults to false.
  -?|-h|--help                                Show help information.
  --runtag                                    Used as a context for metrics reports. Defaults to EGBench.
  --app-insights-key                          AppInsightsKey
  --metrics-interval-seconds                  Frequency of reporting metrics out to console/azmonitor. Defaults to 60
```

### To setup a listener:
```
Usage: dotnet egbench.dll subscriber start [options]

Options:
  -p|--port                   REQUIRED. Port on which to listen
  -t|--runtime-in-minutes     Time after which the subscriber auto-shuts down, defaults to 120 minutes. Set to 0 to never
                              autoshutdown.
  --event-time-property-name  Defaults to eventTime. Use 'time' for Cloud Event v1.0.
  -m|--mean-delay-ms          Fixed subscriber delay (in milliseconds). Defaults to 0. If stdDevDelayInMs is specified, delays are
                              generated via a normal/gaussian distribution, Specify the mean of the distribution here.
  -r|--return-code            HTTP Status code to be returned, formatted as (%,HttpCode). Defaults to 100% HTTP 200. For instance ...
                              -r "10,400" -r "90:200" would result in 10% HTTP 400 responses and 90% HTTP 200. All entries must sum
                              to 100%. Valid separators: , : ; | _ <space>
  --log-payloads              Log all the payloads received, defaults to false.
  -?|-h|--help                Show help information.
  --runtag                    Used as a context for metrics reports. Defaults to EGBench.
  --app-insights-key          AppInsightsKey
  --metrics-interval-seconds  Frequency of reporting metrics out to console/azmonitor. Defaults to 60
```